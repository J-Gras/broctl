# Test that the cleanup command can cleanup a crashed node in a cluster,
# but does not clean the tmpdir unless "--all" is specified.
#
# @TEST-EXEC: bash -x %INPUT
# @TEST-EXEC: btest-diff cleanup.out
# @TEST-EXEC: btest-diff cleanup-onenode.out
# @TEST-EXEC: btest-diff cleanup-all.out
# @TEST-EXEC: btest-diff cleanup-all-onenode.out

. broctl-test-setup

while read line; do installcfgfile "$line"; done << EOF
etc/broctl.cfg__no_email
etc/node.cfg__cluster
bin/bro__test
EOF

cat > $BROCTL_INSTALL_PREFIX/broctltest.cfg << EOF
crash=worker-1
EOF

ret=0

broctl install
broctl start
touch $BROCTL_INSTALL_PREFIX/spool/tmp/testfile
touch $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile

#########################
# test cleanup (without any node arguments)
broctl cleanup 2> cleanup.out

# the node testfile should not exist
test ! -e $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile || ret=1

# the tmpdir testfile should still exist
test -e $BROCTL_INSTALL_PREFIX/spool/tmp/testfile || ret=1

broctl stop
broctl start
touch $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile

#########################
# test cleanup (with a node argument)
broctl cleanup worker-1 2> cleanup-onenode.out

# the node testfile should not exist
test ! -e $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile || ret=1

# the tmpdir testfile should still exist
test -e $BROCTL_INSTALL_PREFIX/spool/tmp/testfile || ret=1

broctl stop
broctl start
touch $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile

########################
# test "cleanup --all" (without a node argument)
broctl cleanup --all 2> cleanup-all.out

# the node testfile should be gone
test ! -e $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile || ret=1

# the tmpdir testfile should be gone
test ! -e $BROCTL_INSTALL_PREFIX/spool/tmp/testfile || ret=1

broctl stop
broctl start
touch $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile
touch $BROCTL_INSTALL_PREFIX/spool/tmp/testfile

########################
# test "cleanup --all" (with a node argument)
broctl cleanup --all worker-1 2> cleanup-all-onenode.out

# the node testfile should be gone
test ! -e $BROCTL_INSTALL_PREFIX/spool/worker-1/testfile || ret=1

# the tmpdir testfile should be gone
test ! -e $BROCTL_INSTALL_PREFIX/spool/tmp/testfile || ret=1

broctl stop

exit $ret

